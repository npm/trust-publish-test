# CircleCI Trusted Publishing Test
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

jobs:
  publish:
    docker:
      - image: cimg/node:lts
    steps:
      - checkout
      
      - run:
          name: "Install dependencies"
          command: npm install
      
      - run:
          name: "Publish to npm with OIDC"
          command: |
            # Build audience claim from configured registry
            NPM_AUDIENCE="npm:$(npm config get registry | sed 's|https\?://||;s|/$||')"
            
            # Get OIDC token and set as NPM_ID_TOKEN
            # npm CLI will automatically exchange this for an npm token
            export NPM_ID_TOKEN=$(circleci run oidc get --claims "{\"aud\": \"$NPM_AUDIENCE\"}")
            
            # Bump version for each publish (using build number for uniqueness)
            npm version 0.0.${CIRCLE_BUILD_NUM} --no-git-tag-version --allow-same-version || true
            
            # Publish - npm CLI handles the token exchange automatically
            npm publish --access public
            
            echo "Successfully published @npm/trust-publish-test"

  debug-claims:
    # Debug job to inspect OIDC token claims without publishing
    docker:
      - image: cimg/node:lts
    steps:
      - checkout
      
      - run:
          name: "Inspect OIDC token claims"
          command: |
            # Build audience claim from configured registry
            NPM_AUDIENCE="npm:$(npm config get registry | sed 's|https\?://||;s|/$||')"
            
            echo "=== Getting OIDC token with npm audience ==="
            OIDC_TOKEN=$(circleci run oidc get --claims "{\"aud\": \"$NPM_AUDIENCE\"}")
            
            echo ""
            echo "=== Decoded JWT payload (claims) ==="
            echo "$OIDC_TOKEN" | cut -d. -f2 | base64 -d 2>/dev/null | jq '.' || echo "Failed to decode"
            
            echo ""
            echo "=== Key claims for npm trusted publishing ==="
            PAYLOAD=$(echo "$OIDC_TOKEN" | cut -d. -f2 | base64 -d 2>/dev/null)
            echo "iss: $(echo "$PAYLOAD" | jq -r '.iss')"
            echo "aud: $(echo "$PAYLOAD" | jq -r '.aud')"
            echo "sub: $(echo "$PAYLOAD" | jq -r '.sub')"
            echo "org-id: $(echo "$PAYLOAD" | jq -r '."oidc.circleci.com/org-id"')"
            echo "project-id: $(echo "$PAYLOAD" | jq -r '."oidc.circleci.com/project-id"')"
            echo "pipeline-definition-id: $(echo "$PAYLOAD" | jq -r '."oidc.circleci.com/pipeline-definition-id"')"
            echo "context-ids: $(echo "$PAYLOAD" | jq -r '."oidc.circleci.com/context-ids"')"
            echo "vcs-origin: $(echo "$PAYLOAD" | jq -r '."oidc.circleci.com/vcs-origin"')"
            echo "vcs-ref: $(echo "$PAYLOAD" | jq -r '."oidc.circleci.com/vcs-ref"')"
            echo "ssh-rerun: $(echo "$PAYLOAD" | jq -r '."oidc.circleci.com/ssh-rerun"')"

workflows:
  # Main publish workflow - triggered manually or on release
  publish-workflow:
    jobs:
      - publish:
          context:
            - main-context
          filters:
            branches:
              only:
                - main
  
  # Debug workflow - for testing claim structure
  debug-workflow:
    jobs:
      - debug-claims:
          context:
            - main-context